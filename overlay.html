<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Image Overlay</title>
  <!-- Try multiple libraries as fallbacks -->
  <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ws@8.14.2/lib/websocket.js"></script>
  <script src="https://unpkg.com/axios@1.6.0/dist/axios.min.js"></script>
  <style>
    body {
      background: transparent;
      margin: 0;
      overflow: hidden;
    }
    #overlayImage {
      position: absolute;
      top: 50%;
      left: 50%;
      max-width: 80%;
      max-height: 80%;
      transform: translate(-50%, -50%);
      display: none;
    }
  </style>
</head>
<body>
  <img id="overlayImage" />
  
  <!-- Test button for debugging -->
  <button id="testButton" style="position:fixed;top:50px;left:10px;z-index:1001;background:blue;color:white;padding:10px;border:none;border-radius:5px;">Test Image</button>
  
  <!-- Manual input for when connection fails -->
  <div id="manualInput" style="position:fixed;top:90px;left:10px;z-index:1001;background:rgba(0,0,0,0.8);padding:10px;border-radius:5px;display:none;">
    <input type="text" id="manualUrl" placeholder="Enter image URL manually" style="width:200px;padding:5px;margin-right:5px;">
    <button id="manualShow" style="background:green;color:white;padding:5px;border:none;border-radius:3px;">Show Image</button>
  </div>

  <script>
    // Get ?channel=USERNAME from URL
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel");

    if (!channel) {
      document.body.innerHTML = "<p style='color:white;font-size:24px'>No channel specified! Add ?channel=YourTwitchName</p>";
    } else {
      console.log("Connecting to Twitch chat for channel:", channel);

      // Add status display
      const statusDiv = document.createElement("div");
      statusDiv.style.cssText = "position:fixed;top:10px;left:10px;color:white;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;font-family:Arial;z-index:1000;";
      statusDiv.innerHTML = "Connecting to " + channel + "...";
      document.body.appendChild(statusDiv);
      
      // Add test button functionality
      document.getElementById("testButton").onclick = function() {
        console.log("Test button clicked");
        const img = document.getElementById("overlayImage");
        img.src = "https://via.placeholder.com/300x200/ff0000/ffffff?text=TEST";
        img.style.display = "block";
        console.log("Test image should be visible now");
        
        setTimeout(() => {
          img.style.display = "none";
          console.log("Test image hidden");
        }, 3000);
      };

      // Try completely different approaches
      let connectionAttempts = 0;
      const maxAttempts = 6;
      
      function tryConnection() {
        connectionAttempts++;
        console.log(`Connection attempt ${connectionAttempts}/${maxAttempts}`);
        
        if (connectionAttempts === 1) {
          tryTmiConnection();
        } else if (connectionAttempts === 2) {
          tryWebSocketConnection();
        } else if (connectionAttempts === 3) {
          tryFetchPolling();
        } else if (connectionAttempts === 4) {
          tryProxyConnection();
        } else if (connectionAttempts === 5) {
          tryCorsProxy();
        } else {
          tryAlternativeService();
        }
      }
      
      function tryTmiConnection() {
        console.log("Trying TMI.js connection...");
        const client = new tmi.Client({
          options: { debug: true },
          connection: { 
            reconnect: false, 
            secure: true,
            timeout: 10000
          },
          channels: [channel]
        });
        
        client.on("connected", (addr, port) => {
          console.log("TMI connection successful:", addr, port);
          statusDiv.innerHTML = "Connected to " + channel + " ✓";
          statusDiv.style.background = "rgba(0,255,0,0.7)";
          setupTmiEvents(client);
        });
        
        client.connect().catch(err => {
          console.error("TMI connection failed:", err);
          if (connectionAttempts < maxAttempts) {
            setTimeout(tryConnection, 2000);
          } else {
            statusDiv.innerHTML = "All connection methods failed";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        });
      }
      
      function tryWebSocketConnection() {
        console.log("Trying direct WebSocket connection...");
        const ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        
        ws.onopen = function() {
          console.log("WebSocket connected");
          ws.send('PASS oauth:anonymous');
          ws.send('NICK justinfan' + Math.floor(Math.random() * 100000));
          ws.send('JOIN #' + channel);
          statusDiv.innerHTML = "Connected to " + channel + " ✓ (WS)";
          statusDiv.style.background = "rgba(0,255,0,0.7)";
        };
        
        ws.onmessage = function(event) {
          const message = event.data;
          console.log("WS message:", message);
          
          if (message.includes('PRIVMSG')) {
            const parts = message.split(' ');
            const username = parts[0].split('!')[0].substring(1);
            const msg = message.split(' :')[1];
            
            if (msg && msg.startsWith('!img ')) {
              const url = msg.split(' ')[1];
              if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                showImage(url);
              }
            }
          }
        };
        
        ws.onerror = function(error) {
          console.error("WebSocket error:", error);
          if (connectionAttempts < maxAttempts) {
            setTimeout(tryConnection, 2000);
          } else {
            statusDiv.innerHTML = "All connection methods failed";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        };
      }
      
      function tryFetchPolling() {
        console.log("Trying fetch polling method...");
        statusDiv.innerHTML = "Trying polling method...";
        statusDiv.style.background = "rgba(255,165,0,0.7)";
        
        // This is a fallback - we'll simulate connection for now
        setTimeout(() => {
          if (connectionAttempts < maxAttempts) {
            setTimeout(tryConnection, 2000);
          } else {
            statusDiv.innerHTML = "All connection methods failed";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        }, 3000);
      }
      
      function tryProxyConnection() {
        console.log("Trying proxy connection...");
        statusDiv.innerHTML = "Trying proxy connection...";
        statusDiv.style.background = "rgba(255,165,0,0.7)";
        
        // Use a different approach - try connecting through a different method
        const client = new tmi.Client({
          options: { debug: true },
          connection: { 
            reconnect: false, 
            secure: true,
            timeout: 10000,
            server: 'wss://irc-ws.chat.twitch.tv:443'
          },
          identity: {
            username: 'justinfan' + Math.floor(Math.random() * 100000),
            password: 'oauth:anonymous'
          },
          channels: [channel]
        });
        
        client.on("connected", (addr, port) => {
          console.log("Proxy connection successful:", addr, port);
          statusDiv.innerHTML = "Connected to " + channel + " ✓ (Proxy)";
          statusDiv.style.background = "rgba(0,255,0,0.7)";
          setupTmiEvents(client);
        });
        
        client.connect().catch(err => {
          console.error("Proxy connection failed:", err);
          if (connectionAttempts < maxAttempts) {
            setTimeout(tryConnection, 2000);
          } else {
            statusDiv.innerHTML = "All connection methods failed";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        });
      }
      
      function tryCorsProxy() {
        console.log("Trying CORS proxy connection...");
        statusDiv.innerHTML = "Trying CORS proxy...";
        statusDiv.style.background = "rgba(255,165,0,0.7)";
        
        // Try using a CORS proxy to connect
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const wsUrl = 'wss://irc-ws.chat.twitch.tv:443';
        
        try {
          const ws = new WebSocket(wsUrl);
          
          ws.onopen = function() {
            console.log("CORS proxy WebSocket connected");
            ws.send('PASS oauth:anonymous');
            ws.send('NICK justinfan' + Math.floor(Math.random() * 100000));
            ws.send('JOIN #' + channel);
            statusDiv.innerHTML = "Connected to " + channel + " ✓ (CORS)";
            statusDiv.style.background = "rgba(0,255,0,0.7)";
          };
          
          ws.onmessage = function(event) {
            const message = event.data;
            console.log("CORS WS message:", message);
            
            if (message.includes('PRIVMSG')) {
              const parts = message.split(' ');
              const username = parts[0].split('!')[0].substring(1);
              const msg = message.split(' :')[1];
              
              if (msg && msg.startsWith('!img ')) {
                const url = msg.split(' ')[1];
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                  showImage(url);
                }
              }
            }
          };
          
          ws.onerror = function(error) {
            console.error("CORS proxy error:", error);
            if (connectionAttempts < maxAttempts) {
              setTimeout(tryConnection, 2000);
            } else {
              statusDiv.innerHTML = "All connection methods failed";
              statusDiv.style.background = "rgba(255,0,0,0.7)";
            }
          };
        } catch (err) {
          console.error("CORS proxy setup failed:", err);
          if (connectionAttempts < maxAttempts) {
            setTimeout(tryConnection, 2000);
          } else {
            statusDiv.innerHTML = "All connection methods failed";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        }
      }
      
      function tryAlternativeService() {
        console.log("Trying alternative service...");
        statusDiv.innerHTML = "Trying alternative service...";
        statusDiv.style.background = "rgba(255,165,0,0.7)";
        
        // Try using a different approach - maybe a different IRC server or method
      const client = new tmi.Client({
          options: { 
            debug: true,
            clientId: 'kimne78kx3ncx6brgo4mv6wki5h1ko'
          },
          connection: { 
            reconnect: false, 
            secure: true,
            timeout: 15000,
            server: 'wss://irc-ws.chat.twitch.tv:443'
          },
          identity: {
            username: 'justinfan' + Math.floor(Math.random() * 100000),
            password: 'oauth:anonymous'
          },
        channels: [channel]
      });

        client.on("connected", (addr, port) => {
          console.log("Alternative service connection successful:", addr, port);
          statusDiv.innerHTML = "Connected to " + channel + " ✓ (Alt)";
          statusDiv.style.background = "rgba(0,255,0,0.7)";
          setupTmiEvents(client);
        });
        
        client.connect().catch(err => {
          console.error("Alternative service connection failed:", err);
          statusDiv.innerHTML = "All connection methods failed - Twitch may be blocking anonymous connections";
          statusDiv.style.background = "rgba(255,0,0,0.7)";
          
          // Show manual input as fallback
          document.getElementById("manualInput").style.display = "block";
          setupManualInput();
        });
      }
      
      function setupTmiEvents(client) {
        client.on("message", handleMessage);
      }
      
      function setupManualInput() {
        document.getElementById("manualShow").onclick = function() {
          const url = document.getElementById("manualUrl").value;
          if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
            showImage(url);
            document.getElementById("manualUrl").value = "";
          } else {
            alert("Please enter a valid URL starting with http:// or https://");
          }
        };
        
        document.getElementById("manualUrl").addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            document.getElementById("manualShow").click();
          }
        });
      }
      
      function showImage(url) {
        console.log("Showing image:", url);
        const img = document.getElementById("overlayImage");
        
        img.onerror = function() {
          console.log("Failed to load image:", url);
          statusDiv.innerHTML = "Failed to load image";
          statusDiv.style.background = "rgba(255,0,0,0.7)";
          img.style.display = "none";
        };
        
        img.onload = function() {
          console.log("Image loaded successfully:", url);
          statusDiv.innerHTML = "Image displayed: " + url.substring(0, 50) + "...";
          statusDiv.style.background = "rgba(0,255,255,0.7)";
        };
        
        img.src = url;
        img.style.display = "block";
        console.log("Image src set to:", url);

        setTimeout(() => {
          img.style.display = "none";
          console.log("Image hidden after 3 seconds");
          statusDiv.innerHTML = "Connected to " + channel + " ✓";
          statusDiv.style.background = "rgba(0,255,0,0.7)";
        }, 3000);
      }
      
      // Add connection timeout
      const connectionTimeout = setTimeout(() => {
        if (statusDiv.innerHTML.includes("Connecting")) {
          statusDiv.innerHTML = "Connection timeout - trying alternative method";
          statusDiv.style.background = "rgba(255,165,0,0.7)";
          console.log("Connection timeout, trying alternative connection...");
        }
      }, 15000);
      
      // Start connection attempts
      tryConnection();

      // Message handling function
      function handleMessage(chan, tags, message, self) {
        console.log("Message received:", {
          channel: chan,
          username: tags.username,
          message: message,
          isMod: tags.mod,
          isBroadcaster: tags.username === channel,
          isSelf: self
        });

        if (self) return;

        // Only allow moderators or broadcaster
        if (!tags.mod && tags.username !== channel) {
          console.log("Message ignored - user is not mod or broadcaster");
          return;
        }

        console.log("User is authorized:", tags.username);

        // Check for !img command
        if (message.startsWith("!img ")) {
          const url = message.split(" ")[1];
          console.log("!img command detected, URL:", url);
          
          if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
            showImage(url);
          } else {
            console.log("Invalid URL format:", url);
            statusDiv.innerHTML = "Invalid URL format";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        }
      }
    }
  </script>
</body>
</html>

