<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Image Overlay</title>
  <!-- Chatis service integration -->
  <style>
    body {
      background: transparent;
      margin: 0;
      overflow: hidden;
    }
    #overlayImage {
      position: absolute;
      top: 50%;
      left: 50%;
      max-width: 80%;
      max-height: 80%;
      transform: translate(-50%, -50%);
      display: none;
    }
  </style>
</head>
<body>
  <img id="overlayImage" />
  
  <!-- Hidden iframe for Chatis chat service -->
  <iframe id="thirdPartyChat" src="" style="display:none;width:0;height:0;border:none;"></iframe>
  
  <!-- Test button for debugging -->
  <button id="testButton" style="position:fixed;top:50px;left:10px;z-index:1001;background:blue;color:white;padding:10px;border:none;border-radius:5px;">Test Image</button>
  
  <!-- Manual input for when connection fails -->
  <div id="manualInput" style="position:fixed;top:90px;left:10px;z-index:1001;background:rgba(0,0,0,0.8);padding:10px;border-radius:5px;display:none;">
    <input type="text" id="manualUrl" placeholder="Enter image URL manually" style="width:200px;padding:5px;margin-right:5px;">
    <button id="manualShow" style="background:green;color:white;padding:5px;border:none;border-radius:3px;">Show Image</button>
  </div>

  <script>
    // Get ?channel=USERNAME from URL
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel");

    if (!channel) {
      document.body.innerHTML = "<p style='color:white;font-size:24px'>No channel specified! Add ?channel=YourTwitchName</p>";
    } else {
      console.log("Connecting to Twitch chat for channel:", channel);

      // Add status display
      const statusDiv = document.createElement("div");
      statusDiv.style.cssText = "position:fixed;top:10px;left:10px;color:white;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;font-family:Arial;z-index:1000;";
      statusDiv.innerHTML = "Connecting to " + channel + "...";
      document.body.appendChild(statusDiv);
      
      // Add test button functionality
      document.getElementById("testButton").onclick = function() {
        console.log("Test button clicked");
        const img = document.getElementById("overlayImage");
        img.src = "https://via.placeholder.com/300x200/ff0000/ffffff?text=TEST";
        img.style.display = "block";
        console.log("Test image should be visible now");
        
        setTimeout(() => {
          img.style.display = "none";
          console.log("Test image hidden");
        }, 3000);
      };

      // Use only Chatis service
      function tryConnection() {
        console.log("Connecting to Chatis service...");
        tryChatisService();
      }
      
      function tryChatisService() {
        console.log("Trying Chatis service...");
        statusDiv.innerHTML = "Trying Chatis service...";
        statusDiv.style.background = "rgba(255,165,0,0.7)";
        
        // Load Chatis chat overlay
        const thirdPartyIframe = document.getElementById('thirdPartyChat');
        thirdPartyIframe.src = `https://chatis.is2511.com/v2/?channel=${channel}&bots=true&size=1&font=11&shadow=1`;
        
        thirdPartyIframe.onload = function() {
          console.log("Chatis service loaded");
          try {
            // Try to access the iframe content
            const iframeDoc = thirdPartyIframe.contentDocument || thirdPartyIframe.contentWindow.document;
            
            // Set up message monitoring
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                  // Look for chat messages in Chatis format
                  const messages = iframeDoc.querySelectorAll('.chat-line, .message, [class*="message"], [class*="chat"]');
                  messages.forEach(function(messageEl) {
                    const text = messageEl.textContent || messageEl.innerText;
                    if (text && text.includes('!img ')) {
                      console.log("Chatis message detected:", text);
                      
                      // Extract username and message
                      const parts = text.split(' ');
                      const username = parts[0] || '';
                      const message = text.substring(text.indexOf('!img '));
                      
                      // Check if it's a mod/broadcaster (simplified check)
                      if (username.toLowerCase() === channel.toLowerCase() || 
                          messageEl.querySelector('[class*="mod"], [class*="broadcaster"], [class*="badge"]')) {
                        const url = message.split(' ')[1];
                        if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                          showImage(url);
                        }
                      }
                    }
                  });
                }
              });
            });
            
            // Start observing
            observer.observe(iframeDoc.body, {
              childList: true,
              subtree: true
            });
            
            statusDiv.innerHTML = "Connected to " + channel + " ✓ (Chatis)";
            statusDiv.style.background = "rgba(0,255,0,0.7)";
            console.log("Chatis observer started");
            
          } catch (error) {
            console.error("Cannot access Chatis content:", error);
            // Try alternative Chatis method
            tryChatisPolling();
          }
        };
        
        thirdPartyIframe.onerror = function() {
          console.error("Failed to load Chatis service");
          statusDiv.innerHTML = "Failed to load Chatis service";
          statusDiv.style.background = "rgba(255,0,0,0.7)";
          showManualInput();
        };
      }
      
      function tryChatisPolling() {
        console.log("Trying Chatis polling method...");
        
        // Use polling to check for messages
        let lastMessageCount = 0;
        const thirdPartyIframe = document.getElementById('thirdPartyChat');
        const pollInterval = setInterval(() => {
          try {
            const iframeDoc = thirdPartyIframe.contentDocument || thirdPartyIframe.contentWindow.document;
            const messages = iframeDoc.querySelectorAll('.chat-line, .message, [class*="message"], [class*="chat"]');
            
            if (messages.length > lastMessageCount) {
              // New messages detected
              for (let i = lastMessageCount; i < messages.length; i++) {
                const messageEl = messages[i];
                const text = messageEl.textContent || messageEl.innerText;
                
                if (text && text.includes('!img ')) {
                  console.log("Chatis polled message:", text);
                  
                  const parts = text.split(' ');
                  const username = parts[0] || '';
                  const message = text.substring(text.indexOf('!img '));
                  
                  if (message.startsWith('!img ')) {
                    const url = message.split(' ')[1];
                    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                      showImage(url);
                    }
                  }
                }
              }
              lastMessageCount = messages.length;
            }
            
            statusDiv.innerHTML = "Connected to " + channel + " ✓ (Chatis Polling)";
            statusDiv.style.background = "rgba(0,255,0,0.7)";
            
          } catch (error) {
            console.error("Chatis polling error:", error);
            clearInterval(pollInterval);
            statusDiv.innerHTML = "Chatis polling failed";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
            showManualInput();
          }
        }, 2000);
      }
      
      
      function showManualInput() {
        document.getElementById("manualInput").style.display = "block";
        setupManualInput();
      }
      
      function setupManualInput() {
        document.getElementById("manualShow").onclick = function() {
          const url = document.getElementById("manualUrl").value;
          if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
            showImage(url);
            document.getElementById("manualUrl").value = "";
          } else {
            alert("Please enter a valid URL starting with http:// or https://");
          }
        };
        
        document.getElementById("manualUrl").addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            document.getElementById("manualShow").click();
          }
        });
      }
      
      function showImage(url) {
        console.log("Showing image:", url);
        const img = document.getElementById("overlayImage");
        
        img.onerror = function() {
          console.log("Failed to load image:", url);
          statusDiv.innerHTML = "Failed to load image";
          statusDiv.style.background = "rgba(255,0,0,0.7)";
          img.style.display = "none";
        };
        
        img.onload = function() {
          console.log("Image loaded successfully:", url);
          statusDiv.innerHTML = "Image displayed: " + url.substring(0, 50) + "...";
          statusDiv.style.background = "rgba(0,255,255,0.7)";
        };
        
        img.src = url;
        img.style.display = "block";
        console.log("Image src set to:", url);

        setTimeout(() => {
          img.style.display = "none";
          console.log("Image hidden after 3 seconds");
          statusDiv.innerHTML = "Connected to " + channel + " ✓";
          statusDiv.style.background = "rgba(0,255,0,0.7)";
        }, 3000);
      }
      
      // Start connection to Chatis
      tryConnection();
    }
  </script>
</body>
</html>

