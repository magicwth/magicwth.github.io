<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Image Overlay</title>
  <script src="https://unpkg.com/tmi.js"></script>
  <style>
    body {
      background: transparent;
      margin: 0;
      overflow: hidden;
    }
    #overlayImage {
      position: absolute;
      top: 50%;
      left: 50%;
      max-width: 80%;
      max-height: 80%;
      transform: translate(-50%, -50%);
      display: none;
    }
  </style>
</head>
<body>
  <img id="overlayImage" />
  
  <!-- Test button for debugging -->
  <button id="testButton" style="position:fixed;top:50px;left:10px;z-index:1001;background:blue;color:white;padding:10px;border:none;border-radius:5px;">Test Image</button>

  <script>
    // Get ?channel=USERNAME from URL
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel");

    if (!channel) {
      document.body.innerHTML = "<p style='color:white;font-size:24px'>No channel specified! Add ?channel=YourTwitchName</p>";
    } else {
      console.log("Connecting to Twitch chat for channel:", channel);
      
      // Add status display
      const statusDiv = document.createElement("div");
      statusDiv.style.cssText = "position:fixed;top:10px;left:10px;color:white;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;font-family:Arial;z-index:1000;";
      statusDiv.innerHTML = "Connecting to " + channel + "...";
      document.body.appendChild(statusDiv);
      
      // Add test button functionality
      document.getElementById("testButton").onclick = function() {
        console.log("Test button clicked");
        const img = document.getElementById("overlayImage");
        img.src = "https://via.placeholder.com/300x200/ff0000/ffffff?text=TEST";
        img.style.display = "block";
        console.log("Test image should be visible now");
        
        setTimeout(() => {
          img.style.display = "none";
          console.log("Test image hidden");
        }, 3000);
      };

      // Connect anonymously to Twitch IRC
      const client = new tmi.Client({
        connection: { reconnect: true, secure: true },
        channels: [channel]
      });

      // Connection event handlers
      client.on("connected", (addr, port) => {
        console.log("Connected to Twitch IRC:", addr, port);
        statusDiv.innerHTML = "Connected to " + channel + " ✓";
        statusDiv.style.background = "rgba(0,255,0,0.7)";
      });

      client.on("disconnected", (reason) => {
        console.log("Disconnected from Twitch IRC:", reason);
        statusDiv.innerHTML = "Disconnected: " + reason;
        statusDiv.style.background = "rgba(255,0,0,0.7)";
      });

      client.on("notice", (channel, msgid, message) => {
        console.log("Twitch notice:", msgid, message);
        statusDiv.innerHTML = "Notice: " + message;
        statusDiv.style.background = "rgba(255,165,0,0.7)";
      });

      client.connect().catch(err => {
        console.error("Connection error:", err);
        statusDiv.innerHTML = "Connection error: " + err.message;
        statusDiv.style.background = "rgba(255,0,0,0.7)";
      });

      client.on("message", (chan, tags, message, self) => {
        console.log("Message received:", {
          channel: chan,
          username: tags.username,
          message: message,
          isMod: tags.mod,
          isBroadcaster: tags.username === channel,
          isSelf: self
        });

        if (self) return;

        // Only allow moderators or broadcaster
        if (!tags.mod && tags.username !== channel) {
          console.log("Message ignored - user is not mod or broadcaster");
          return;
        }

        console.log("User is authorized:", tags.username);

        // Check for !img command
        if (message.startsWith("!img ")) {
          const url = message.split(" ")[1];
          console.log("!img command detected, URL:", url);
          
          if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
            const img = document.getElementById("overlayImage");
            
            // Add error handling for image loading
            img.onerror = function() {
              console.log("Failed to load image:", url);
              statusDiv.innerHTML = "Failed to load image";
              statusDiv.style.background = "rgba(255,0,0,0.7)";
              img.style.display = "none";
            };
            
            img.onload = function() {
              console.log("Image loaded successfully:", url);
              statusDiv.innerHTML = "Image displayed: " + url.substring(0, 50) + "...";
              statusDiv.style.background = "rgba(0,255,255,0.7)";
            };
            
            img.src = url;
            img.style.display = "block";
            console.log("Image src set to:", url);
            console.log("Image display set to block");
            console.log("Image element:", img);
            console.log("Image computed style:", window.getComputedStyle(img).display);

            // Hide image after 3 seconds
            setTimeout(() => {
              img.style.display = "none";
              console.log("Image hidden after 3 seconds");
              statusDiv.innerHTML = "Connected to " + channel + " ✓";
              statusDiv.style.background = "rgba(0,255,0,0.7)";
            }, 3000);
          } else {
            console.log("Invalid URL format:", url);
            statusDiv.innerHTML = "Invalid URL format";
            statusDiv.style.background = "rgba(255,0,0,0.7)";
          }
        }
      });
    }
  </script>
</body>
</html>
